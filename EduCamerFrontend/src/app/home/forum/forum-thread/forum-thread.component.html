<div class="thread-container" *ngIf="thread$ | async as thread; else loading">
  <div class="thread-header">
    <a [routerLink]="['/home/course', courseId, 'forum']" mat-icon-button matTooltip="Retour au forum">
      <mat-icon>arrow_back</mat-icon>
    </a>
    <div class="header-content">
      <h1>{{ thread.title }}</h1>
      <div class="thread-meta">
        <span>Démarré par <strong>{{ thread.authorName }}</strong></span>
        <span>•</span>
        <span>{{ thread.createdAt | date:'longDate' }}</span>
      </div>
    </div>
  </div>

  <div class="post-list">
    <mat-card *ngFor="let post of thread.posts" class="post-card" 
              [class.author-post]="post.authorId === thread.authorId">
      <mat-card-header>
        <img mat-card-avatar [src]="post.authorAvatarUrl || 'assets/welcome/profile.svg'">
        <mat-card-title>{{ post.authorName }}</mat-card-title>
        <mat-card-subtitle>{{ post.createdAt | date:'medium' }}</mat-card-subtitle>
        
        <div class="post-actions" *ngIf="authService.hasPermission('forum:moderate')">
          <button mat-icon-button [matMenuTriggerFor]="menu"><mat-icon>more_vert</mat-icon></button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="editPost(post)"><mat-icon>edit</mat-icon><span>Modifier</span></button>
            <button mat-menu-item (click)="deletePost(post.id)"><mat-icon color="warn">delete</mat-icon><span>Supprimer</span></button>
          </mat-menu>
        </div>
      </mat-card-header>
      <mat-card-content class="post-content" [innerHTML]="post.content | safeHtml"></mat-card-content>
    </mat-card>
  </div>

  <mat-card class="reply-card">
    <mat-card-header>
      <mat-card-title>Participer à la discussion</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="replyForm" (ngSubmit)="onReply()">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Votre réponse...</mat-label>
          <textarea matInput formControlName="content" rows="5" cdkTextareaAutosize #autosize="cdkTextareaAutosize"></textarea>
        </mat-form-field>
        <button mat-flat-button color="primary" type="submit" [disabled]="replyForm.invalid">
          <mat-icon>send</mat-icon> Publier ma réponse
        </button>
      </form>
    </mat-card-content>
  </mat-card>
</div>
<ng-template #loading><div class="loading-spinner"><mat-spinner></mat-spinner></div></ng-template>